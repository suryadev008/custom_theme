---
product:
    videos:
        limit: {{theme_settings.productpage_videos_count}}
    reviews:
        limit: {{theme_settings.productpage_reviews_count}}
    related_products:
        limit: {{theme_settings.productpage_related_products_count}}
    similar_by_views:
        limit: {{theme_settings.productpage_similar_by_views_count}}
---
{{inject 'productId' product.id}}

{{#partial "page"}}

    {{> components/common/breadcrumbs breadcrumbs=breadcrumbs}}

    {{#each product.shipping_messages}}
        {{> components/common/alert/alert-info message}}
    {{/each}}

    <div>
        {{> components/products/product-view}}

        {{{region name="product_below_content"}}}

        {{#if product.videos.list.length}}
            {{> components/products/videos product.videos}}
        {{/if}}

        {{#all settings.show_product_reviews theme_settings.show_product_reviews (if theme_settings.show_product_details_tabs '!==' true)}}
            {{> components/products/reviews reviews=product.reviews product=product urls=urls}}
        {{/all}}

        {{> components/products/tabs}}
    </div>

    {{> components/products/schema}}
    
    <script>
        let customData=document.querySelector('#customfields').textContent;
        let dataArr=JSON.parse(customData)
       let prodId= dataArr.map((elm)=>{
          if(elm.name=='upsell_products'){
            return elm.value; 
          }
        })

        // get the products from store
        var query =  `query {
                        site {
                            products(entityIds: ${prodId}) {
                            edges {
                                node {
                                name
                                entityId
                                prices {
                                    price {
                                    value
                                    currencyCode
                                    }
                                }
                                }
                            }
                            }
                        }
                        }`
             
                axios({
                url: '/graphql',
                method: 'post',
                async: false,
                contentType: "application/json",
                headers: {
                    'Authorization': 'Bearer {{ settings.storefront_api.token }}'
               },
                data: {
                  query:query
                }
              }).then((result) => {  
                  let upsell_products=result.data.data.site.products.edges;

                let htmlCodde=``;
                htmlCodde+=`<div class="">
                <label class=""
                    id="radio-group-label">
                    Upsell Products:
                </label><br>`
                  upsell_products.map((elm)=>{
                    htmlCodde+=`<br>
                    <input type="checkbox" id="upsell_${elm.node.entityId}" class="upsellCheckbox" name="${elm.node.entityId}" value="${elm.node.entityId}" onchange="priceUpdate(${elm.node.entityId})"  data-price="${elm.node.prices.price.value}" data-id="${elm.node.entityId}">
                    <label for="upsell_${elm.node.entityId}"> ${elm.node.name} Price:${elm.node.prices.price.value}  ${elm.node.prices.price.currencyCode} </label> <br>`
                  })
                  htmlCodde+=`</div>`;
                const div = document.querySelector('#upslleProd');
                div.innerHTML += htmlCodde
              });

            //  price update function start 
              function priceUpdate(prodid) {
                const priceElement = document.querySelector('span.price--withTax');
                const priceText = priceElement.innerText.trim();
                const priceTrim = priceText.replace(/[^\d.-]/g, '');
                const price = parseFloat(priceTrim);
                let updateprice=0;
                const checkBox = document.getElementById(`upsell_${prodid}`);
                const CheckBoxprice = parseFloat(checkBox.dataset.price);
                if(checkBox.checked){
                    updateprice= price+CheckBoxprice
                }else{
                    updateprice= price-CheckBoxprice
                }                
                const formatter = new Intl.NumberFormat(undefined, { minimumFractionDigits: 2 });
                const formattedString = formatter.format(updateprice);
                priceElement.textContent="Rs"+formattedString;
              }
              //  price update function end
            //   add to cart code
            async function addUpsellItemToCart() {
                document.querySelector("#form-action-addToCart").value='Adding to Cart'
                const checkBoxObj=document.querySelectorAll('.upsellCheckbox');
                let prodArr={"lineItems":[]}
                checkBoxObj.forEach((elm) => {
                    if(elm.checked){
                        const prodId = parseInt(elm.dataset.id);
                        prodArr.lineItems.push({"quantity":1,"productId":prodId})
                    }            
                });

                const form = document.getElementById('formcart');
                const formData = new FormData(form);
                const data = {};
                const optionArr = [];
                formData.forEach((value, key) => {
                    if(key=='qty[]'){
                        data['qty'] = value;
                    }else{
                        data[key] = value;
                    }
                    if(key.includes("attribute")){
                        let optId=parseInt(key.match(/\d+/)[0], 10);
                        optionArr.push({"optionId":optId,"optionValue":value});
                    }
                });
                prodArr.lineItems.push({"quantity":data.qty,"productId":parseInt(data.product_id),"optionSelections":optionArr})

                let cartID= await getCartId();
                if(cartID!=0){
                    updateCart(prodArr,cartID);
                }else{
                    createCart(prodArr);
                }
    
            }


            // get the cart id
            function getCartId() {                    
                    const options = {method: 'GET', headers: {'Content-Type': 'application/json'}};
                    return fetch('https://okshopping.mybigcommerce.com/api/storefront/carts', options)
                    .then(response => response.json())
                    .then(response => {
                    if (response !== undefined && response.length > 0) {
                        return response[0].id;
                    } else {
                        return 0;
                    }    
                }).catch(err => console.error(err));                
            }
            // get the cart id end

            // get the cart id
            async function createCart(bodyData) {                    
                const options = {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body:JSON.stringify(bodyData)
                    };
                    await fetch('https://okshopping.mybigcommerce.com/api/storefront/carts', options)
                    .then(response => response.json())
                    .then(response => {
                        // alert("Product Add to cart");
                        console.log(response)
                        // if (response !== undefined && response.length > 0) {
                            if(response.id){
                                document.querySelector("#form-action-addToCart").value='Add to Cart'
                                alert("Product Add to cart");
                                setTimeout(() => {
                                    window.location.href = '/cart.php'; 
                                }, 3000);
                            }
                        // }
                    })
                    .catch(err => console.error(err));
            }
            
            function updateCart(bodydata,cartID) { 
                    const options = {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(bodydata)
                        };
                        fetch('https://okshopping.mybigcommerce.com/api/storefront/carts/'+cartID+'/items', options)
                        .then(response => response.json())
                        .then(response => {
                            console.log(response)
                            // alert("Product Add to cart");
                        //     if (response !== undefined && response.length > 0) {
                            
                            if(response.id){
                                document.querySelector("#form-action-addToCart").value='Add to Cart'
                                alert("Product Add to cart");
                                setTimeout(() => {
                                    window.location.href = '/cart.php'; 
                                }, 3000);
                            }
                        // }
                        })
                        .catch(err => console.error(err));
                    
            }
            
           
            // add to cart code end 
              
     </script>
{{/partial}}

{{> layout/base}}
